# Define variables
$plinkPath = "C:\path\to\plink.exe"   # Update with the correct path to plink
$jsonParamFile = "C:\path\to\param_file.json"  # Update with your JSON parameter file path

# Registry path for storing SSH host keys
$regBasePath = "HKCU:\Software\SimonTatham\PuTTY"
$regPath = "$regBasePath\SshHostKeys"

# Check if the base registry path exists, if not, create it
if (-not (Test-Path $regPath)) {
    Write-Output "Registry path for SSH host keys not found, creating it..."
    New-Item -Path $regBasePath -Name "SshHostKeys" -Force
}

# Read the JSON param file
$userHostList = Get-Content $jsonParamFile | ConvertFrom-Json

# Loop through each entry in the JSON and retrieve/store host key
foreach ($entry in $userHostList) {
    $connectionName = $entry.connectionName
    $user = $entry.user
    $remoteHost = $entry.remoteHost  # Changed variable name to remoteHost
    $keyPath = $entry.keyPath

    Write-Output "[$connectionName] Retrieving host key for $user@$remoteHost"

    # Create the plink arguments
    $arguments = "-v -ssh -i `"$keyPath`" $user@$remoteHost echo Host key checked"

    # Start the process with input redirection to automatically accept the host key
    $process = Start-Process -FilePath $plinkPath -ArgumentList $arguments -NoNewWindow -RedirectStandardInput "Yes" -RedirectStandardOutput -PassThru

    # Wait for the process to complete
    $process.WaitForExit()

    # Capture the output from plink
    $plinkOutput = $process.StandardOutput.ReadToEnd()

    # Use regular expression to match both "Host key fingerprint is" and the fingerprint itself
    if ($plinkOutput -match "Host key fingerprint is:\r?\n(ssh-[a-zA-Z0-9-]+) \d+ SHA256:([a-zA-Z0-9+/=]+)") {
        $hostKeyType = $matches[1]     # Key type (e.g., ssh-rsa)
        $hostKeyFingerprint = $matches[2]  # The actual SHA256 fingerprint

        # Prepare the registry key name (PuTTY uses this format: e.g., "ssh-rsa@22:hostname")
        $regKeyName = "$hostKeyType@22:$remoteHost"

        # Check if the registry key for this host already exists
        if (Get-ItemProperty -Path $regPath -Name $regKeyName -ErrorAction SilentlyContinue) {
            # Registry entry exists, compare fingerprints
            $existingHostKey = (Get-ItemProperty -Path $regPath).$regKeyName

            if ($existingHostKey -eq "SHA256:$hostKeyFingerprint") {
                Write-Output "[$connectionName] Host key for $remoteHost is already up to date."
            } else {
                # Host key changed, update the key in the registry
                Write-Warning "[$connectionName] Host key for $remoteHost has changed! Updating the key in the registry."
                Set-ItemProperty -Path $regPath -Name $regKeyName -Value "SHA256:$hostKeyFingerprint"
            }
        } else {
            # Host key does not exist, add it to the registry
            Write-Output "[$connectionName] Adding host key to registry for $remoteHost"
            New-ItemProperty -Path $regPath -Name $regKeyName -Value "SHA256:$hostKeyFingerprint" -PropertyType String
        }
    } else {
        Write-Error "[$connectionName] Failed to retrieve or parse host key fingerprint for $user@$remoteHost"
    }
}
