# Define the directory where the batch files are located
$batchFileDirectory = "C:\Scripts"

# Define the list of batch files to execute after the initial two
$batchFiles = @(
    Join-Path $batchFileDirectory "batch3.bat",
    Join-Path $batchFileDirectory "batch4.bat",
    Join-Path $batchFileDirectory "batch5.bat"
)

# Define a script block to execute the batch files, including the function
$scriptBlock = {
    param (
        [string]$batchFile
    )
    
    # Define the Execute-BatchFile function within the script block
    function Execute-BatchFile {
        param (
            [string]$batchFile
        )
        
        # Start the batch file process
        $process = Start-Process -FilePath $batchFile -NoNewWindow -PassThru
        $process.WaitForExit()

        # Return the exit code of the batch file
        return $process.ExitCode
    }

    # Call the function with the provided batch file
    Execute-BatchFile -batchFile $batchFile
}

# Run batch1 and batch2 simultaneously using jobs
$batch1Job = Start-Job -ScriptBlock $scriptBlock -ArgumentList (Join-Path $batchFileDirectory "batch1.bat")
$batch2Job = Start-Job -ScriptBlock $scriptBlock -ArgumentList (Join-Path $batchFileDirectory "batch2.bat")

# Wait for both jobs to finish
$results = Receive-Job -Job $batch1Job, $batch2Job -Wait -AutoRemoveJob

# Check exit codes of batch1 and batch2
$batch1Success = $results[0] -eq 0
$batch2Success = $results[1] -eq 0

if ($batch1Success -and $batch2Success) {
    Write-Output "batch1.bat and batch2.bat completed successfully. Proceeding with the rest."

    # Loop through each of the remaining batch files and execute them in sequence
    foreach ($batchFile in $batchFiles) {
        $exitCode = Execute-BatchFile -batchFile $batchFile
        if ($exitCode -ne 0) {
            Write-Output "$batchFile failed with exit code $exitCode. Stopping execution."
            break
        } else {
            Write-Output "$batchFile completed successfully."
        }
    }
} else {
    Write-Output "batch1.bat or batch2.bat failed. Stopping execution."
}
